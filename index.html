<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Phonebook</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="/phonebook/favicon.png">
    <style>
        input {
            width: 250px;
            padding: 10px;
            margin: 0px 15px;
            border: 1px solid #eee;
        }
        
        button {
            padding: 10px;
            margin: 25px 21px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
            width: 105px;
        }
        
        .wrap {
            margin: 15% auto;
            width: 300px;
        }
        
        .search {
            background: #00aeff;
        }
        
        .add {
            background: #3dbf44;
        }
        
        #errors_in_name,
        #errors_in_phone {
            margin: 15px 15px 0;
            color: red;
            font-family: Arial;
            font-weight: bold;
        }
        
        .result {
            font-family: Arial;
            font-size: 16px;
            margin: 0 15px;
            color: red;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class='result'></div>
        <div id='errors_in_name'>
        </div>
        <input placeholder="Name" type='text' name='user_name' id='user_name' />
        <div id='errors_in_phone'>
        </div>
        <input placeholder="Phone (in any format)" type='text' name='user_phone' id='user_phone' />
        <button class='search'>Find number</button>
        <button class='add'>Add contact</button>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
        function search() {
            var user_name = $('#user_name').val()
            $('#user_phone').val('');
            $('#errors_in_name').text('');
            $('#errors_in_phone').text('');
            $('#user_phone').css('border', '1px solid #eee');
            $('#user_name').css('border', '1px solid #eee');
            $('.result').text('');
            if (user_name == '') {
                $('#errors_in_name').text('❌ Please enter a name!');
                $('#user_name').css('border', '1px solid red');
            } else if (localStorage.getItem(user_name) !== null) {
                $('.result').text(user_name + ': ✆ ' + localStorage.getItem(user_name));
                $('.result').css('color', 'green');
            } else {
                $.ajax({
                    url: 'http://API/contacts',
                    data: {
                        'where': '{"name":"' + user_name + '"}'
                    },
                    type: 'GET',
                    success: function(data) {
                        if (data._items.length == 0) {
                            $('.result').text('❌ Contact not found!');
                            $('.result').css('color', 'red');
                        } else {
                            var user_phone = data._items[0]['phone']
                            $('.result').text(user_name + ': ✆ ' + user_phone);
                            $('.result').css('color', 'green');
                            localStorage.setItem(user_name, user_phone)
                        }
                    },
                    error: function(data) {
                        $('.result').text('❌ Connection Error!');
                        $('.result').css('color', 'red');
                    }
                });
            }
        }

        function add_contact() {
            var user_name = $('#user_name').val()
            var user_phone = $('#user_phone').val()
            var nameRegex = new RegExp(/^\s*[а-яА-ЯёЁa-zA-Z]+[а-яА-ЯёЁa-zA-Z\s]*$/);
            var phoneRegex = new RegExp(/^\s*[\+\(]?[\d]{1,5}[\-\s\/\)]?[\(\s]?[\d]{0,5}[\)]?[\-\s\/\.]?[\d]{0,5}[\-\s\/\.]?[\d]{0,5}[\-\s\/\.]?[\d]{0,5}\s*$/);
            var checkName = nameRegex.test(user_name)
            var checkPhone = phoneRegex.test(user_phone)
            $('#errors_in_name').text('');
            $('#errors_in_phone').text('');
            $('#user_phone').css('border', '1px solid #eee');
            $('#user_name').css('border', '1px solid #eee');
            $('.result').text('');
            if (user_name == '' && user_phone == '') {
                $('#errors_in_name').text('❌ Please enter a name!');
                $('#user_name').css('border', '1px solid red');
                $('#errors_in_phone').text('❌ Please enter the number!');
                $('#user_phone').css('border', '1px solid red');
            } else if (user_name == '' && user_phone !== '') {
                $('#errors_in_name').text('❌ Please enter a name!');
                $('#user_name').css('border', '1px solid red');
                $('#errors_in_phone').text('');
                $('#user_phone').css('border', '1px solid #eee');
            } else if (user_phone == '' && user_name !== '') {
                $('#errors_in_phone').text('❌ Please enter the number!');
                $('#user_phone').css('border', '1px solid red');
                $('#errors_in_name').text('');
                $('#user_name').css('border', '1px solid #eee');
            }  else if (!checkName && !checkPhone) {
                $('#errors_in_name').text('❌ You entered is not a name!');
                $('#user_name').css('border', '1px solid red');
                $('#errors_in_phone').text('❌ You entered is not a phone!');
                $('#user_phone').css('border', '1px solid red');
            } else if (!checkName && checkPhone) {
                $('#errors_in_name').text('❌ You entered is not a name!');
                $('#user_name').css('border', '1px solid red');
                $('#errors_in_phone').text('');
                $('#user_phone').css('border', '1px solid #eee');
            } else if (checkName && !checkPhone) {
                $('#errors_in_name').text('');
                $('#user_name').css('border', '1px solid #eee');
                $('#errors_in_phone').text('❌ You entered is not a phone!');
                $('#user_phone').css('border', '1px solid red');
            } else if (localStorage.getItem(user_name) !== null) {
                $('#errors_in_name').text('❌ The entered contact is already exists!');
                $('#user_name').css('border', '1px solid red');
                $('#errors_in_phone').text(user_name + ': ✆ ' + localStorage.getItem(user_name));
                $('#errors_in_phone').css('color', 'green');
                $('#user_phone').css('border', '1px solid red');
            } else {
                $.ajax({
                    url: 'http://API/contacts',
                    data: {
                        'name': user_name,
                        'phone': user_phone
                    },
                    type: 'POST',
                    success: function(data) {
                        if (data._status == 'OK') {
                            $('.result').text('✓ Contact successfully added!');
                            $('.result').css('color', 'green');
                            localStorage.setItem(user_name, user_phone)
                        } else {
                            $('.result').text('');
                            if(typeof data._issues.name !== "undefined") {
                                $('#user_name').css('border', '1px solid red');
                                if (!Array.isArray(data._issues.name)) {
                                    $('#errors_in_name').text('❌ — ' + data._issues.name);
                                } else {
                                    $('#errors_in_name').html(data._issues.name.map(i => '❌ — ' + i).join('<br>'));
                                }
                            }
                            if(typeof data._issues.phone !== "undefined") {
                                $('#user_phone').css('border', '1px solid red');
                                if (!Array.isArray(data._issues.phone)) {
                                    $('#errors_in_phone').text('❌ — ' + data._issues.phone);
                                } else {
                                    $('#errors_in_phone').html(data._issues.phone.map(i => '❌ — ' + i).join('<br>'));
                                }
                            }
                        }
                    },
                    error: function(data) {
                        $('.result').text('❌ Connection Error!');
                        $('.result').css('color', 'red');
                    }
                });
            }
        }
        $(document).ready(function() {
            $('.search').on('click', function() {
                search();
            });
            $('#user_name').on('keypress', function(e) {
                if (e.which === 13) {
                    $(this).attr("disabled", "disabled");
                    search();
                    $(this).removeAttr("disabled");
                }
            });
            $('.add').on('click', function() {
                add_contact();
            });
            $('#user_phone').on('keypress', function(e) {
                if (e.which === 13) {
                    $(this).attr("disabled", "disabled");
                    add_contact();
                    $(this).removeAttr("disabled");
                }
            });

        });
    </script>
</body>

</html>
